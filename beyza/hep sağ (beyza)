#include "ALACAKART.h"

ALACA_KART Veri_Kontrol;

const int SERVO_NEUTRAL = 90;
const int SERVO_LEFT = 60;
const int SERVO_RIGHT = 120;

const int MOTOR_RUN_PWM = 2000;  // Max hız
const int MOTOR_STOP_PWM = 1490; // Durdurma PWM (ESC için gerekli)

unsigned long start_time = 0;
unsigned long last_log_time = 0;

void setup() {
  Serial.begin(57600);
  Veri_Kontrol.Sensor_begin();

  // Servo başlatma
  Veri_Kontrol.Servo_1_begin(); // ESC
  Veri_Kontrol.Servo_2_begin(); // Roll sol
  Veri_Kontrol.Servo_3_begin(); // Pitch ön
  Veri_Kontrol.Servo_4_begin(); // Roll sağ
  Veri_Kontrol.Servo_5_begin(); // Pitch arka

  // ESC yavaş başlatma
  Serial.println(">>> ESC PWM yavaşça artırılıyor...");
  for (int pwm = MOTOR_STOP_PWM; pwm <= MOTOR_RUN_PWM; pwm += 2) {
    Veri_Kontrol.Servo_1(pwm);
    delay(10);
  }

  start_time = millis();
}

void loop() {
  unsigned long now = millis();
  float gecen_sure = (now - start_time) / 1000.0;

  // İlk 10 saniye bekleme (motor durur)
  if (gecen_sure < 10.0) {
    Veri_Kontrol.Servo_1(MOTOR_STOP_PWM);
    Veri_Kontrol.Servo_2_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_3_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_4_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_5_Write(SERVO_NEUTRAL);
  } else {
    // Motor çalışsın
    Veri_Kontrol.Servo_1(MOTOR_RUN_PWM);

    if (gecen_sure >= 10.0 && gecen_sure < 35.0) {
      // Sadece sağa dön
      Veri_Kontrol.Servo_3_Write(SERVO_LEFT);
      Veri_Kontrol.Servo_5_Write(SERVO_RIGHT);
    } else {
      // Düz git
      Veri_Kontrol.Servo_3_Write(SERVO_NEUTRAL);
      Veri_Kontrol.Servo_5_Write(SERVO_NEUTRAL);
    }

    Veri_Kontrol.Servo_2_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_4_Write(SERVO_NEUTRAL);
  }

  // 35. saniyeden sonra sistem kapanır
  if (gecen_sure >= 35.0) {
    Serial.println(">>> Sistem duruyor...");
    Veri_Kontrol.Servo_1(MOTOR_STOP_PWM);
    Veri_Kontrol.Servo_2_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_3_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_4_Write(SERVO_NEUTRAL);
    Veri_Kontrol.Servo_5_Write(SERVO_NEUTRAL);
    while (true);
  }

  // Telemetri (opsiyonel)
  Serial.print("Zaman: ");
  Serial.println(gecen_sure, 2);

  delay(20);
}
