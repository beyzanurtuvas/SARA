#include "ALACAKART.h"
#include <SPI.h>
#include <SD.h>

ALACA_KART Veri_Kontrol;
File Veri;

// Sabitler
const int CS_SD = PA4;
const int SERVO_NEUTRAL = 90;       // Duz konum
const int SERVO_LEFT = 45;          // Saga donuste on servo sola, arka servo saga
const int SERVO_RIGHT = 135;        // Sola donuste on servo saga, arka servo sola
const int MOTOR_RUN_PWM = 2000;     // Maksimum hiz
const int MOTOR_STOP_PWM = 1490;    // ESC arming ve durdurma PWM
const int MOTOR_LOW_PWM = 1600;     // Hafif calisma

unsigned long baslangic = 0;

// Motor PWM’ini kademeli artir
void motorYavasArtir(int baslangicPWM, int hedefPWM) {
  for (int pwm = baslangicPWM; pwm <= hedefPWM; pwm += 2) {
    Veri_Kontrol.Servo_1(pwm); // ESC sinyali gonder
    delay(10);
  }
}

// Motor PWM’ini kademeli azalt
void motorYavasAzalt(int baslangicPWM, int hedefPWM) {
  for (int pwm = baslangicPWM; pwm >= hedefPWM; pwm -= 2) {
    Veri_Kontrol.Servo_1(pwm); // ESC sinyali gonder
    delay(10);
  }
}

void setup() {
  Serial.begin(57600);
  Veri_Kontrol.Sensor_begin();

  // Servo pinleri baslatiliyor
  Veri_Kontrol.Servo_1_begin(); // ESC (motor)
  Veri_Kontrol.Servo_2_begin(); // Yunuslama: Yukari/asagi hareket - On servo
  Veri_Kontrol.Servo_3_begin(); // Yon kontrolu: Donus - On servo
  Veri_Kontrol.Servo_4_begin(); // Yunuslama: Yukari/asagi hareket - Arka servo
  Veri_Kontrol.Servo_5_begin(); // Yon kontrolu: Donus - Arka servo

  // SD Kart baslatiliyor
  SPI.begin();
  if (SD.begin(CS_SD)) {
    Veri = SD.open("Veriler.txt", FILE_WRITE);
    if (Veri) Veri.println("Zaman");
  }

  baslangic = millis();
}

void loop() {
  unsigned long simdi = millis();
  float sure = (simdi - baslangic) / 1000.0;

  if (sure < 10) {
    // Baslangicta bekleme suresi (motor kapali)
    Veri_Kontrol.Servo_1(MOTOR_STOP_PWM);
  } else if (sure >= 10 && sure < 12) {
    // Motoru yavas calistir
    motorYavasArtir(MOTOR_STOP_PWM, MOTOR_RUN_PWM);
  } else if (sure >= 12 && sure < 14) {
    // 2 saniye duz git
    Veri_Kontrol.Servo_1(MOTOR_RUN_PWM);
    tumServolariNotrle();
  } else if (sure >= 14 && sure < 15) {
    // Motoru yavas yavas durdur
    motorYavasAzalt(MOTOR_RUN_PWM, MOTOR_STOP_PWM);
  } else if (sure >= 15 && sure < 16) {
    // Saga donmeye hazirlan: motoru tekrar artir
    motorYavasArtir(MOTOR_STOP_PWM, MOTOR_RUN_PWM);
  } else if (sure >= 16 && sure < 21) {
    // 5 saniye saga don (yaw)
    Veri_Kontrol.Servo_1(MOTOR_RUN_PWM);
    Veri_Kontrol.Servo_3_Write(SERVO_LEFT);  // On servo sola
    Veri_Kontrol.Servo_5_Write(SERVO_RIGHT); // Arka servo saga
  } else if (sure >= 21 && sure < 22) {
    // Yavasca durdur
    motorYavasAzalt(MOTOR_RUN_PWM, MOTOR_STOP_PWM);
  } else if (sure >= 22 && sure < 23) {
    // Sola donmeye hazirlan
    motorYavasArtir(MOTOR_STOP_PWM, MOTOR_RUN_PWM);
  } else if (sure >= 23 && sure < 28) {
    // 5 saniye sola don (yaw ters)
    Veri_Kontrol.Servo_1(MOTOR_RUN_PWM);
    Veri_Kontrol.Servo_3_Write(SERVO_RIGHT); // On servo saga
    Veri_Kontrol.Servo_5_Write(SERVO_LEFT);  // Arka servo sola
  } else if (sure >= 28 && sure < 29) {
    // Durdur
    motorYavasAzalt(MOTOR_RUN_PWM, MOTOR_STOP_PWM);
  } else if (sure >= 29 && sure < 30) {
    // Yunuslama oncesi motoru tekrar calistir
    motorYavasArtir(MOTOR_STOP_PWM, MOTOR_RUN_PWM);
  } else if (sure >= 30 && sure < 32) {
    // Asagi eg (inis): pitch kontrol
    Veri_Kontrol.Servo_2_Write(SERVO_RIGHT); // On servo asagi
    Veri_Kontrol.Servo_4_Write(SERVO_LEFT);  // Arka servo yukari
  } else if (sure >= 32 && sure < 34) {
    // Notr pozisyona gel (duzles)
    tumServolariNotrle();
  } else if (sure >= 34 && sure < 36) {
    // Yukari eg (cikis)
    Veri_Kontrol.Servo_2_Write(SERVO_LEFT);  // On servo yukari
    Veri_Kontrol.Servo_4_Write(SERVO_RIGHT); // Arka servo asagi
  } else if (sure >= 36) {
    // Sistem tamamen durur
    motorYavasAzalt(MOTOR_RUN_PWM, MOTOR_STOP_PWM);
    tumServolariNotrle();
    if (Veri) Veri.close();
    Serial.println(">>> Sistem durdu.");
    while (true);
  }

  delay(20);
}

void tumServolariNotrle() {
  // Tum yon/pitch servolarini notr konuma getir
  Veri_Kontrol.Servo_2_Write(SERVO_NEUTRAL);
  Veri_Kontrol.Servo_3_Write(SERVO_NEUTRAL);
  Veri_Kontrol.Servo_4_Write(SERVO_NEUTRAL);
  Veri_Kontrol.Servo_5_Write(SERVO_NEUTRAL);
}
