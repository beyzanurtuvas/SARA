#include "ALACAKART.h"
#include "MS5837.h"
#include "Servo_Ext_ALC.h"

ALACA_KART Veri_Kontrol;
MS5837 basincSensoru;
Servo_Ext_ALC Motor;

int yunus_asamasi = 0;
float referansDerinlik = 0.0;
unsigned long ileriBaslangicZamani;

void setup() {
  Serial.begin(9600);
  Veri_Kontrol.baslat();
  basincSensoru.baslat();
  Motor.baslat();
  delay(1000); // sistem stabil gelsin
}

void loop() {
  Veri_Kontrol.veriYenile();
  float derinlik = basincSensoru.derinlik();

  switch (yunus_asamasi) {
    case 0:
      // Başlangıç derinliğini referans al
      referansDerinlik = derinlik;
      Serial.print("Başlangıç Derinliği: "); Serial.println(referansDerinlik);
      yunus_asamasi = 1;
      break;

    case 1:
      // 15 cm aşağı in
      if (derinlik < referansDerinlik + 0.15) {
        Motor.Servo_1(1100);  // dalış yönlü PWM
      } else {
        Motor.Servo_1(1500);  // durdur
        delay(300); // biraz bekle
        ileriBaslangicZamani = millis();
        yunus_asamasi = 2;
        Serial.println(">> 15cm dalış tamam, ileri gidiliyor...");
      }
      break;

    case 2:
      // 2 saniye ileri hareket
      Motor.Servo_2(1800); // ileri yönlü motor (Servo_2 ileri motor)
      if (millis() - ileriBaslangicZamani >= 2000) {
        Motor.Servo_2(1500); // ileri motoru durdur
        yunus_asamasi = 3;
        Serial.println(">> 2sn ileri tamam, çıkış başlıyor...");
      }
      break;

    case 3:
      // Yüzeye doğru çıkış
      Motor.Servo_1(1900); // yukarı yönlü PWM
      if (derinlik <= 0.2) {
        Motor.Servo_1(1500); // motoru durdur
        Veri_Kontrol.Buzzer(true); // buzzer çal
        yunus_asamasi = 4;
        Serial.println(">> Yüzeye ulaşıldı, sistem kapatıldı");
      }
      break;

    case 4:
      // sistem pasif
      break;
  }

  delay(100);
}
