#include "ALACAKART.h"
#include <SPI.h>
#include <SD.h>

ALACA_KART Veri_Kontrol;
File Veri;

// Sabitler
const int CS_SD = PA4;
const int SERVO_NEUTRAL = 90;
const int MOTOR_RUN_PWM = 2000;
const int MOTOR_STOP_PWM = 1490;

// PID Sabitleri (gecici degerler)
float Kp_yaw = 1.2, Ki_yaw = 0.0, Kd_yaw = 0.5;
float Kp_pitch = 1.2, Ki_pitch = 0.0, Kd_pitch = 0.5;

// PID degiskenleri
float yaw_integral = 0, yaw_last_error = 0;
float pitch_integral = 0, pitch_last_error = 0;

unsigned long oncekiZaman = 0;

void setup() {
  Serial.begin(57600);
  Veri_Kontrol.Sensor_begin();

  // Servolar
  Veri_Kontrol.Servo_1_begin(); // ESC
  Veri_Kontrol.Servo_2_begin(); // Pitch on
  Veri_Kontrol.Servo_3_begin(); // Yaw on
  Veri_Kontrol.Servo_4_begin(); // Pitch arka
  Veri_Kontrol.Servo_5_begin(); // Yaw arka

  // SD Kart
  SPI.begin();
  if (SD.begin(CS_SD)) {
    Veri = SD.open("Veriler.csv", FILE_WRITE);
    if (Veri) {
      Veri.println("Time_ms,Pitch,Pitch_Target,Pitch_Error,Pitch_Output,Yaw,Yaw_Target,Yaw_Error,Yaw_Output");
    }
  }

  oncekiZaman = millis();
}

void loop() {
  unsigned long simdi = millis();
  float dt = (simdi - oncekiZaman) / 1000.0;
  oncekiZaman = simdi;

  float pitch = Veri_Kontrol.Euler_Y();
  float yaw = Veri_Kontrol.Euler_Z();
  float pitch_target = 0;
  float yaw_target = 0;

  // Pitch PID hesaplama
  float pitch_error = pitch_target - pitch;
  pitch_integral += pitch_error * dt;
  float pitch_derivative = (pitch_error - pitch_last_error) / dt;
  float pitch_output = Kp_pitch * pitch_error + Ki_pitch * pitch_integral + Kd_pitch * pitch_derivative;
  pitch_output = constrain(pitch_output, -45, 45);
  pitch_last_error = pitch_error;

  // Yaw PID hesaplama
  float yaw_error = yaw_target - yaw;
  yaw_integral += yaw_error * dt;
  float yaw_derivative = (yaw_error - yaw_last_error) / dt;
  float yaw_output = Kp_yaw * yaw_error + Ki_yaw * yaw_integral + Kd_yaw * yaw_derivative;
  yaw_output = constrain(yaw_output, -45, 45);
  yaw_last_error = yaw_error;

  // PID ciktilarini servolara uygula
  Veri_Kontrol.Servo_2_Write(SERVO_NEUTRAL + pitch_output); // Pitch on
  Veri_Kontrol.Servo_4_Write(SERVO_NEUTRAL - pitch_output); // Pitch arka
  Veri_Kontrol.Servo_3_Write(SERVO_NEUTRAL + yaw_output);   // Yaw on
  Veri_Kontrol.Servo_5_Write(SERVO_NEUTRAL - yaw_output);   // Yaw arka

  // ESC calistir (sabirli PWM, test icin)
  Veri_Kontrol.Servo_1(MOTOR_RUN_PWM);

  // SD karta veri yaz
  if (Veri) {
    Veri.print(simdi); Veri.print(",");
    Veri.print(pitch); Veri.print(",");
    Veri.print(pitch_target); Veri.print(",");
    Veri.print(pitch_error); Veri.print(",");
    Veri.print(pitch_output); Veri.print(",");
    Veri.print(yaw); Veri.print(",");
    Veri.print(yaw_target); Veri.print(",");
    Veri.print(yaw_error); Veri.print(",");
    Veri.println(yaw_output);
  }

  delay(100); // 10Hz loglama
}
